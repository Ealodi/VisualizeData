<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3柱状图</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    #wrap {
      width: 700px;
      height: 500px;
      margin: 0 auto;
    }
    .container {
      margin: 40px auto 0;
      display: block;
    }
    #prompt {
      width: 60px;
      height: 40px;
      border-radius: 4px;
      text-align: center;
      line-height: 40px;
      background: #666;
      color: #fff;
      display: none;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
      transition: all 0.1s;
    }
    .tool {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="prompt"></div>
  </div>
  <hr/>
  <div class="tool">
    <button id="btn-sort">排序</button>
    <button id="btn-add">添加</button>
  </div>

  <script>

    const WIDTH = 600; // 画布宽度
    const HEIGHT = 400; // 画布高度
    const PADDING = 30; // 画布四周空间

    // 模拟数据，假设这里是每个省份的高效数量
    let dataList = [
      { school: "青海师范大学", scoreline: 429 },
      { school: "青海大学", scoreline: 499 },
      { school: "广西师范大学", scoreline: 515},
      { school: "燕山大学", scoreline: 550 },
      { school: "广西大学", scoreline: 554 },
      { school: "合肥工业大学", scoreline: 566 },
      { school: "西南大学", scoreline: 567 },
      { school: "重庆大学", scoreline: 603 },
      { school: "华中科技大学", scoreline: 623 },
      { school: "武汉大学", scoreline: 625 },
      { school: "中国科学技术大学", scoreline: 661 },
    ];

    // 排序标记
    let sort_flag = false;

    // 生成svg画布
    d3.select('#wrap')
      .append('svg')
      .classed('container', true)
      .attr('width', WIDTH + PADDING * 2)
      .attr('height', HEIGHT + PADDING * 2)
      .style('background', '#f0f0f0')

    // 容器画布
    let container = d3.select('.container')

    // y线性比例尺
    let yScale = d3.scaleLinear()
      .domain([0, d3.max(dataList, d => d.scoreline)])
      .range([HEIGHT, 0]) // 坐标轴从下往上，所以反过来
    let yAxis = d3.axisLeft(yScale);

    // x序数比例尺
    let xScale = d3.scaleBand()
      .domain(dataList.map(d => d.school))
      .range([0, WIDTH])
      .paddingInner(0.2); // 定义柱形之间的间隙
    let xAxis = d3.axisBottom(xScale);

    // y轴坐标轴展示
    container.append('g')
      .attr('id', 'yAxis')
      .attr('transform', 'translate(' + PADDING + ',' + PADDING + ')')
      .call(yAxis)

    // x轴坐标轴展示
    container.append('g')
      .attr('id', 'xAxis')
      .attr('transform', 'translate(' + PADDING + ',' + (HEIGHT + PADDING) + ')')
      .call(xAxis)

    // 柱状图容器
    let rectGroup = container.append('g').attr('id', 'rectGroup');
    // 文本容器
    let textGroup = container.append('g').attr('id', 'textGroup');

    // 加载rect
    function renderRect() {
      rectGroup.selectAll('rect')
        .data(dataList)
        .enter()
        .append('rect')
        .classed('rect', true)
        .on('click', (d) => { // 添加点击提示的事件
          let x = d3.event.pageX;
          let y = d3.event.pageY;
          d3.select('#prompt')
            .style('display', 'block')
            .style('left', x + 'px')
            .style('top', y + 'px')
            .text(d.school) // 修改此处为 school
        })

      container.selectAll('.rect')
        .attr('width', xScale.bandwidth())
        .attr('height', 0)
        .attr('x', (d) => {
          return xScale(d.school) + PADDING
        })
        .attr('y', (d) => {
          return HEIGHT + PADDING
        })
        .style('fill', 'skyblue')
        .transition() // 设置过渡
        .duration(300)
        .delay((d, i) => {
          return i * 20
        })
        .attr('height', (d) => {
          return HEIGHT - yScale(d.scoreline)
        })
        .attr('y', (d) => {
          return yScale(d.scoreline) + PADDING
        })

    }

    // 加载文本
    function renderText() {
      textGroup.selectAll('text')
        .data(dataList)
        .enter()
        .append('text')
        .classed('text', true)

      textGroup.selectAll('text')
        .attr('text-anchor', 'middle')
        .text((d) => {
          return d.scoreline;
        })
        .attr('x', (d) => {
          return xScale(d.school) + xScale.bandwidth() / 2 + PADDING;
        })
        .attr('y', HEIGHT + PADDING - 10)
        .transition()
        .duration(300)
        .delay((d, i) => {
          return i * 20
        })
        .attr('y', (d) => {
          return yScale(d.scoreline) + PADDING - 10
        })
        .style('fill', (d) => {
          if (d.scoreline > 25) { // 大于25的文本显示为红色
            return 'red';
          }
        });
    }

    // 更新视图（修改数据时调用）
    function refresh() {
      // 更新比例尺
      yScale.domain([0, d3.max(dataList, d => d.scoreline)]);
      d3.select('#yAxis').call(yAxis);
      xScale.domain(dataList.map(d => d.school));
      d3.select('#xAxis').call(xAxis);

      // 重新加载内容
      renderRect();
      renderText();
    }

    // 加载事件
    function initEvent() {
      // 离开时关闭提示
      d3.select('#wrap').on('mouseleave', () => {
        d3.select('#prompt').style('display', 'none');
      });

      // 点击排序
      d3.select('#btn-sort').on('click', () => {
        rectGroup.selectAll('rect')
          .sort((a, b) => { // d3自带方法，升序降序
            return sort_flag ? d3.descending(a.scoreline, b.scoreline) : d3.ascending(a.scoreline, b.scoreline);
          })
          .transition()
          .duration(500)
          .attr('x', (d) => {
            return xScale(d.school) + PADDING;
          });

        textGroup.selectAll('text')
          .sort((a, b) => { // d3自带方法，升序降序
            return sort_flag ? d3.descending(a.scoreline, b.scoreline) : d3.ascending(a.scoreline, b.scoreline);
          })
          .transition()
          .duration(500)
          .attr('x', (d) => {
            return xScale(d.school) + xScale.bandwidth() / 2 + PADDING;
          });

        sort_flag = !sort_flag; // 切换顺序
      });

      // 点击添加
      d3.select('#btn-add').on('click', () => {
        // 生成一个随机数字，模拟新的高效数量
        let randomScoreline = Math.ceil(Math.random() * 50);
        
        // 随机选择一个省份，模拟添加数据
        let randomIndex = Math.floor(Math.random() * dataList.length);
        dataList[randomIndex].scoreline = randomScoreline;

        refresh(); // 更新视图
      });
    }

    // 视图初始化
    renderRect();
    renderText();
    initEvent();

  </script>
</body>
</html>



