<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>China Map</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>

<script>
    var width = 600;
    var height = 600;
    var color = d3.scaleOrdinal(d3.schemeCategory10); 
    var svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    var projection = d3.geoMercator()
        .center([105, 35])  //调整经纬度以居中显示中国
        .scale(400)         //调整缩放比例
        .translate([width / 2, height / 2]);
    var path = d3.geoPath().projection(projection);
    //阈值比例尺
    var inputDomain = [0,50,100,150,200,300,450,650,1204];
    var outputRange = d3.schemeBlues[9];
    //创建阈值比例尺
    var thresholdScale = d3.scaleThreshold()
        .domain(inputDomain)
        .range(outputRange);

    //创建提示框
    var text_num = d3.select("body").append("div")
        .attr("class", "text")
        .style("opacity", 0);

    Promise.all([
        d3.csv("https://raw.githubusercontent.com/Ealodi/VisualizeData/master-branch/2017.csv"),
        d3.json("https://raw.githubusercontent.com/Ealodi/VisualizeData/master-branch/china.geo.json")
    ]).then(function(data){
        //console.log(data[0]);
        // 创建路径元素并绑定数据
        svg.selectAll("path")
            .data(data[1].features)
            .enter()
            .append("path")
            .attr("name",function(d,i){return d.properties.name;})
            .attr("universityCount",function(d,i){
                //把大学数量设置到属性里，方便取用
                var name = d.properties.name;
                var selectedData = data[0].filter(function(d) {
                    return d.province === name;
                });
                // 获取对应省份的大学数量
                var universityCount = selectedData.length;
                return universityCount;
            })
            .attr("fill",function(d,i){
                var universityCount = d3.select(this).attr("universityCount");
                return thresholdScale(universityCount);//线性颜色比例尺调用
            })
            .attr("stroke", "#4f4343")
            .attr("stroke-width", 1)
            .attr("d", path)
            .on("click",function(d,i){
                event.preventDefault();
                var myElement = d3.select("svg");
                var elementNode = myElement.node();
                var rect = elementNode.getBoundingClientRect();
                var x = rect.left + rect.width + 200,y = -608;
                hubei(x,y);
            })
            .on("mouseover",function(d,i){
                var universityCount = d3.select(this).attr("universityCount");
                var name = d3.select(this).attr("name");
                // 获取区块的中心坐标
                var bounds = this.getBBox();
                var centerX = bounds.x + bounds.width / 2;
                var centerY = bounds.y + bounds.height / 2;
                // 显示数字
                text_num.transition()
                    .duration(100)
                    .style("opacity", .9);
                text_num.html(name + "有 " + universityCount + " 所大学")
                    .style("left", (centerX + window.pageXOffset) + "px")
                    .style("top", (centerY + window.pageXOffset) + "px");
                
                d3.select(this)
                    .transition()
                    .duration(100)
                    .attr("stroke-width","3")
                    .attr("stroke", "yellow");
            })
            .on("mouseout",function(d,i){
                var universityCount = d3.select(this).attr("universityCount");
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("stroke-width",1)
                    .attr("stroke", "#4f4343");
                // 删除数字
                text_num.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

            
    });
    function hubei(x,y){
        const WIDTH = 500; // 画布宽度
        const HEIGHT = 500; // 画布高度
        const PADDING = 30; // 画布四周空间
        d3.select("body")
            .append("div")
            .attr("id","wrap");
        d3.select("div")
            .append("div")
            .attr("id","prompt");
        // 模拟数据，假设这里是每个省份的高效数量
        let dataList = [
        { school: "青海师范大学", scoreline: 429 },
        { school: "青海大学", scoreline: 499 },
        { school: "广西师范大学", scoreline: 515},
        { school: "燕山大学", scoreline: 550 },
        { school: "广西大学", scoreline: 554 },
        { school: "合肥工业大学", scoreline: 566 },
        { school: "西南大学", scoreline: 567 },
        { school: "重庆大学", scoreline: 603 },
        { school: "华中科技大学", scoreline: 623 },
        { school: "武汉大学", scoreline: 625 },
        { school: "中国科学技术大学", scoreline: 661 },
        ];

        // 排序标记
        let sort_flag = false;
        // 生成svg画布
        d3.select('#wrap')
        .append('svg')
        .classed('container', true)
        .attr('width', WIDTH + PADDING * 2)
        .attr('height', HEIGHT + PADDING * 2)
        .style('background', '#f0f0f0')
        .attr("transform","translate(" + x + "," + y + ")");

        // 容器画布
        let container = d3.select('.container')

        // y线性比例尺
        let yScale = d3.scaleLinear()
        .domain([0, d3.max(dataList, d => d.scoreline)])
        .range([HEIGHT, 0]) // 坐标轴从下往上，所以反过来
        let yAxis = d3.axisLeft(yScale);

        // x序数比例尺
        let xScale = d3.scaleBand()
        .domain(dataList.map(d => d.school))
        .range([0, WIDTH])
        .paddingInner(0.2); // 定义柱形之间的间隙
        let xAxis = d3.axisBottom(xScale);

        // y轴坐标轴展示
        container.append('g')
        .attr('id', 'yAxis')
        .attr('transform', 'translate(' + PADDING + ',' + PADDING + ')')
        .call(yAxis)

        // x轴坐标轴展示
        container.append('g')
        .attr('id', 'xAxis')
        .attr('transform', 'translate(' + PADDING + ',' + (HEIGHT + PADDING) + ')')
        .call(xAxis)

        // 柱状图容器
        let rectGroup = container.append('g').attr('id', 'rectGroup');
        // 文本容器
        let textGroup = container.append('g').attr('id', 'textGroup');

        // 加载rect
        function renderRect() {
        rectGroup.selectAll('rect')
            .data(dataList)
            .enter()
            .append('rect')
            .classed('rect', true)
            .on('click', (d) => { // 添加点击提示的事件
            let x = d3.event.pageX;
            let y = d3.event.pageY;
            d3.select('#prompt')
                .style('display', 'block')
                .style('left', x + 'px')
                .style('top', y + 'px')
                .text(d.school) // 修改此处为 school
            })

        container.selectAll('.rect')
            .attr('width', xScale.bandwidth())
            .attr('height', 0)
            .attr('x', (d) => {
            return xScale(d.school) + PADDING
            })
            .attr('y', (d) => {
            return HEIGHT + PADDING
            })
            .style('fill', 'skyblue')
            .transition() // 设置过渡
            .duration(300)
            .delay((d, i) => {
            return i * 20
            })
            .attr('height', (d) => {
            return HEIGHT - yScale(d.scoreline)
            })
            .attr('y', (d) => {
            return yScale(d.scoreline) + PADDING
            })

        }

        // 加载文本
        function renderText() {
        textGroup.selectAll('text')
            .data(dataList)
            .enter()
            .append('text')
            .classed('text', true)

        textGroup.selectAll('text')
            .attr('text-anchor', 'middle')
            .text((d) => {
            return d.scoreline;
            })
            .attr('x', (d) => {
            return xScale(d.school) + xScale.bandwidth() / 2 + PADDING;
            })
            .attr('y', HEIGHT + PADDING - 10)
            .transition()
            .duration(300)
            .delay((d, i) => {
            return i * 20
            })
            .attr('y', (d) => {
            return yScale(d.scoreline) + PADDING - 10
            })
            .style('fill', (d) => {
            if (d.scoreline > 25) { // 大于25的文本显示为红色
                return 'red';
            }
            });
        }

        // 更新视图（修改数据时调用）
        function refresh() {
        // 更新比例尺
        yScale.domain([0, d3.max(dataList, d => d.scoreline)]);
        d3.select('#yAxis').call(yAxis);
        xScale.domain(dataList.map(d => d.school));
        d3.select('#xAxis').call(xAxis);

        // 重新加载内容
        renderRect();
        renderText();
        }

        // 加载事件
        function initEvent() {
        // 离开时关闭提示
        d3.select('#wrap').on('mouseleave', () => {
            d3.select('#prompt').style('display', 'none');
        });

        // 点击排序
        d3.select('#btn-sort').on('click', () => {
            rectGroup.selectAll('rect')
            .sort((a, b) => { // d3自带方法，升序降序
                return sort_flag ? d3.descending(a.scoreline, b.scoreline) : d3.ascending(a.scoreline, b.scoreline);
            })
            .transition()
            .duration(500)
            .attr('x', (d) => {
                return xScale(d.school) + PADDING;
            });

            textGroup.selectAll('text')
            .sort((a, b) => { // d3自带方法，升序降序
                return sort_flag ? d3.descending(a.scoreline, b.scoreline) : d3.ascending(a.scoreline, b.scoreline);
            })
            .transition()
            .duration(500)
            .attr('x', (d) => {
                return xScale(d.school) + xScale.bandwidth() / 2 + PADDING;
            });

            sort_flag = !sort_flag; // 切换顺序
        });
        }

        // 视图初始化
        renderRect();
        renderText();
        initEvent();
    }
  
  </script>
<style>
        .text {
            position: absolute;
            text-align: left;
            padding: 5px;
            font: 12px sans-serif;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5;
            pointer-events: none;
        }
</style>
</body>
</html>
